CREATE DATABASE DE01
GO
USE DE01
GO
SET DATEFORMAT dmy 
GO
CREATE TABLE TACGIA
(
    MATG CHAR(5) PRIMARY KEY,
    HOTEN VARCHAR(20),
    DIACHI VARCHAR(50),
    NGSINH SMALLDATETIME,
    SODT VARCHAR(15)
)
GO
CREATE TABLE SACH
(
    MASACH CHAR(5) PRIMARY KEY,
    TENSACH VARCHAR(25),
    THELOAI VARCHAR(25)
)
GO
CREATE TABLE TACGIA_SACH
(
    MATG CHAR(5) REFERENCES TACGIA,
    MASACH CHAR(5) REFERENCES SACH,
    PRIMARY KEY (MATG,MASACH)
)
GO
CREATE TABLE PHATHANH
(
    MAPH CHAR(5) PRIMARY KEY,
    MASACH CHAR(5) REFERENCES SACH,
    NGAYPH SMALLDATETIME,
    SOLUONG INT,
    NHAXUATBAN VARCHAR(20)
)
GO
INSERT INTO TACGIA (MaTG, HoTen, DiaChi, NgSinh, SoDT)
VALUES 
('TG001', 'Nguyen Van A', '123 ABC Street, HCMC', '15-05-1990', '123456789'),
('TG002', 'Tran Thi B', '456 XYZ Street, Hanoi', '20-09-1985', '987654321'),
('TG003', 'Pham Van C', '789 DEF Street, Danang', '10-12-1995', '111222333'),
('TG004', 'Le Van D', '111 GHI Street, Hue', '25-03-1980', '444555666'),
('TG005', 'Hoang Thi E', '222 JKL Street, Nha Trang', '08-07-1992', '777888999');
INSERT INTO TACGIA (MaTG, HoTen, DiaChi, NgSinh, SoDT)
VALUES 
('TG006', 'Nguyen Van F', '333 GHI Street, Hanoi', '12-06-1987', '555666777'),
('TG007', 'Tran Van G', '444 JKL Street, Danang', '05-09-1998', '888999000'),
('TG008', 'Pham Thi H', '555 MNO Street, Hue', '18-11-1990', '111000222'),
('TG009', 'Le Van I', '666 PQR Street, Nha Trang', '25-03-1985', '333444555'),
('TG010', 'Hoang Van K', '777 STU Street, HCMC', '30-07-1993', '666777888');

INSERT INTO TACGIA_SACH (MaTG, MaSach)
VALUES 
('TG006', 'S001'),
('TG007', 'S001'),
('TG008', 'S002'),
('TG009', 'S003'),
('TG010', 'S004');
INSERT INTO PHATHANH (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
VALUES 
('PH006', 'S001', '10-06-2023', 120, 'NXB A'),
('PH007', 'S001', '15-07-2023', 130, 'NXB A'),
('PH008', 'S002', '20-08-2023', 140, 'NXB B'),
('PH009', 'S003', '25-09-2023', 150, 'NXB C'),
('PH010', 'S004', '30-10-2023', 160, 'NXB D');


INSERT INTO SACH (MaSach, TenSach, TheLoai)
VALUES 
('S001', 'ToiThayHoaVang', 'Truyen'),
('S002', 'Nguoi Lon Nhat', 'Kinh dien'),
('S003', 'Tam Quoc Di Nghia', 'Lich su'),
('S004', 'Sherlock Holmes', 'Trinh tham'),
('S005', 'Harry Potter', 'Fantasy');

INSERT INTO TACGIA_SACH (MaTG, MaSach)
VALUES 
('TG001', 'S001'),
('TG002', 'S002'),
('TG003', 'S003'),
('TG004', 'S004'),
('TG005', 'S005');
INSERT INTO PHATHANH (MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan)
VALUES 
('PH001', 'S001', '10-01-2023', 100, 'NXB A'),
('PH002', 'S002', '15-02-2023', 150, 'NXB B'),
('PH003', 'S003', '20-03-2023', 120, 'NXB C'),
('PH004', 'S004', '25-04-2023', 200, 'NXB D'),
('PH005', 'S005', '30-05-2023', 180, 'NXB E');





CREATE TRIGGER TRG_UP_IN_GH ON 
FOR UPDATE,INSERT
AS BEGIN
    IF EXISTS(
        SELECT * FROM inserted I JOIN  ON 
        WHERE 
    )
    BEGIN
     PRINT'LOI: INPUT KO HOP LE'
     ROLLBACK TRANSACTION
    END
    ELSE
    BEGIN
     PRINT 'THANH CONG'
    END
END
GO
SELECT TACGIA.MATG,HOTEN,SODT FROM TACGIA JOIN TACGIA_SACH ON TACGIA.MATG = TACGIA_SACH.MATG
                                    JOIN PHATHANH ON TACGIA_SACH.MASACH = PHATHANH.MASACH
                                    JOIN SACH ON SACH.MASACH = PHATHANH.MASACH
WHERE THELOAI = 'VAN HOC' AND NHAXUATBAN = 'TRE'
GO
SELECT TOP 1 WITH TIES NHAXUATBAN  FROM PHATHANH JOIN SACH ON PHATHANH.MASACH = SACH.MASACH
GROUP BY NHAXUATBAN
ORDER BY COUNT(DISTINCT THELOAI) DESC
GO
SELECT NHAXUATBAN,TACGIA.MATG,TACGIA.HOTEN FROM PHATHANH JOIN TACGIA_SACH ON PHATHANH.MASACH = TACGIA_SACH.MASACH
                                            JOIN TACGIA ON TACGIA.MATG = TACGIA_SACH.MATG
where 

GO
SELECT
GO
SELECT
GO
SELECT
GO